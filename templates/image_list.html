<!--- image_list.html -->
{% extends 'base.html' %} 

{% block title %}AI Greeting Cards | All images{% endblock %}

{% block content %}
<div class="container text-center">
    <div class="row d-flex justify-content-center">
        <h1 class="my-4">All images</h1>
        <a href="{% url 'home' %}" class="btn btn-light btn-block mb-4" data-mdb-ripple-color="dark">Generate Image</a>
        {% if task_id %}
            <div id="loading-spinner">Loading...</div>
        {% endif %}
        
        <div id="image-list-container">
            {% include 'partials/image_list_content.html' %}
        </div>
    </div>
    {% if task_id %}
        <div id="task-status"></div>
        <script>
            function checkTaskStatus(task_id) {
                console.log('Checking task status for task_id:', task_id);
                fetch(`/check-task-status/${task_id}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Task status response:', data);
                    if (data.status === 'completed') {
                        console.log('Image generation completed!');
                        document.getElementById('loading-spinner').style.display = 'none';
                        document.getElementById('task-status').innerText = 'Image generation completed!';
                        htmx.ajax('GET', '/images/refresh/', '#image-list-container').then(function() {
                            console.log('Image list refreshed');
                        });
                    } else if (data.status.startsWith('failed')) {
                        console.log('Image generation failed:', data.status);
                        document.getElementById('loading-spinner').style.display = 'none';
                        document.getElementById('task-status').innerText = data.status;
                    } else {
                        console.log('Image still processing');
                        setTimeout(() => checkTaskStatus(task_id), 2000);  // Poll every 2 seconds
                    }
                })
                .catch(error => {
                    console.error('Error checking task status:', error);
                });
            }
        
            document.addEventListener('DOMContentLoaded', function() {
                var task_id = "{{ task_id }}";
                console.log('DOMContentLoaded event fired');
                if (task_id) {
                    console.log('Page loaded with task_id:', task_id);
                    checkTaskStatus(task_id);
                } else {
                    console.log('No task_id found');
                }
            });
        </script>
    {% endif %}
</div>
{% endblock %}
